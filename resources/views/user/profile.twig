{% extends 'templates/app.twig' %}

{% block title %}Profile - {{ user.username }}{% endblock %}

{% block extrajs %}
	<script>
	function jq(myid) {
		return "#" + myid.replace(/(:|\.|\[|\]|,|=|\ |\-)/g, "\\$1");
	}

	$(function() {
		$('[id^=delete-file-]').click(function(event) {
			event.preventDefault();
			var filename = $(this).attr('id').replace('delete-file-', '');
			var element = this;
			$.get({
				url: {{ path_for('file.delete', {filename: ''}) }} + filename,
				success: function() {
					$(element).parent().parent().remove();
				}
			});
			return false;
		});
	});
	</script>
{% endblock %}

{% block content %}
	<div class="row">
		<div class="col-md-12">
			<h1>
				{% if user.name %}
					{{ user.name }} <small>({{ user.username }})</small>
				{% else %}
					{{ user.username }}
				{% endif %}
			</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-md-4">
			<p>
				{% if user.isAdmin() %}
					<span class="label label-danger">Administrator</span>
				{% elseif user.isModerator() %}
					<span class="label label-warning">Moderator</span>
				{% endif %}
			</p>

			<dl>
				{% if user.website is not empty %}
					<dt>Website</dt>
					<dd><a href="{{ user.website }}">{{ user.website }}</a></dd>
				{% endif %}
				{% if user.bio is not empty %}
					<dt>Bio</dt>
					<dd>
						{{ user.bio | markdown }}
					</dd>
				{% endif %}
			</dl>
			{% if user.id == auth.user.id %}
				<p>
					<a href="{{ path_for('user.profile.edit') }}">Edit your profile</a>
				</p>
			{% elseif auth.user.isAdmin() %}
				<p>
					<a href="{{ path_for('admin.user.giveperms', {'uid': user.id}) }}">Change usergroup</a>
				</p>
			{% endif %}
		</div>
		<div class="col-md-{{ (user.id == auth.user.id or auth.user.isModerator()) ? '6' : '8' }}">
			{% if page.files.count > 0 %}
				<table class="table table-striped table-bordered table-hover">
					<thead>
						<tr>
							<th>File</th>
							{% if user.id == auth.user.id or auth.user.isModerator() %}
								<th>Privacy</th>
								<th>Delete</th>
							{% endif %}
						</tr>
					</thead>
					<tbody>
						{% for file in page.files %}
							{% set filename = file.id ~ (file.filename is not empty ? '-' ~ file.filename : '') ~ (file.ext is not empty ? '.' ~ file.ext : '') %}
							<tr>
								<td>
									<a id="file-entry-{{ filename | url_encode }}" href="{{ path_for('file.view', {'filename': filename | url_encode }) }}">{{ filename }}</a>
								</td>
								{% if user.id == auth.user.id or auth.user.isModerator() %}
									{% if file.privacy_state == 0 %}
										{% set privacy = "Public" %}
									{% elseif file.privacy_state == 1 %}
										{% set privacy = "Unlisted" %}
									{% else %}
										{% set privacy = "Private" %}
									{% endif %}
									<td>
										{{ privacy }}
									</td>
									<td>
										<button type="button" class="btn btn-danger btn-xs" id="delete-file-{{ filename | url_encode }}">Delete</button>
									</td>
								{% endif %}
							</tr>
						{% endfor %}
					</tbody>
				</table>

				{% if page.last != 1 %}
					<nav aria-label="Page navigation">
						<ul class="pagination">
							<li{% if page.current == 1 %} class="disabled"{% endif %}>
								<a href="{{ path_for('user.profile', {'id': user.id}) }}?page=1">
									<span aria-hidden="true"><span class="fa fa-angle-double-left"></span></span>
									<span class="sr-only">First</span>
								</a>
							</li>
							<li{% if page.current == 1 %} class="disabled"{% endif %}>
								<a href="{{ path_for('user.profile', {'id': user.id}) }}?page={{ page.current - 1 }}">
									<span aria-hidden="true"><span class="fa fa-angle-left"></span></span>
									<span class="sr-only">Previous</span>
								</a>
							</li>
							{% if page.current < 6 %}
								{% for p in 1..(page.last < 6 ? page.last : 6) %}
									<li{% if p == page.current %} class="active"{% endif %}><a href="{{ path_for('user.profile', {'id': user.id}) }}?page={{ p }}">{{ p }}</a></li>
								{% endfor %}
								{% if page.last > 6 %}
									<li><span>...</span></li>
								{% endif %}
							{% elseif page.current > (page.last - 6) %}
								{% if page.last - 6 > 0 %}<li><span>...</span></li>{% endif %}
								{% for p in (page.last - 6 > 0 ? page.last - 6 : 1)..page.last %}
									<li{% if p == page.current %} class="active"{% endif %}><a href="{{ path_for('user.profile', {'id': user.id}) }}?page={{ p }}">{{ p }}</a></li>
								{% endfor %}
							{% else %}
								<li><span>...</span></li>
								{% for p in page.current - 3..page.current + 3 %}
									<li{% if p == page.current %} class="active"{% endif %}><a href="{{ path_for('user.profile', {'id': user.id}) }}?page={{ p }}">{{ p }}</a></li>
								{% endfor %}
								<li><span>...</span></li>
							{% endif %}
							<li{% if page.current == page.last %} class="disabled"{% endif %}>
								<a href="{{ path_for('user.profile', {'id': user.id}) }}?page={{ page.current + 1 }}">
									<span aria-hidden="true"><span class="fa fa-angle-right"></span></span>
									<span class="sr-only">Next</span>
								</a>
							</li>
							<li{% if page.current == page.last %} class="disabled"{% endif %}>
								<a href="{{ path_for('user.profile', {'id': user.id}) }}?page={{ page.last }}">
									<span aria-hidden="true"><span class="fa fa-angle-double-right"></span></span>
									<span class="sr-only">Last</span>
								</a>
							</li>
						</ul>
					</nav>
				{% endif %}
			{% else %}
				<b>This user hasn't uploaded any files.</b> :(
			{% endif %}
		</div>
		{% if user.id == auth.user.id or auth.user.isModerator() %}
			{% include 'templates/partials/privacy-levels-desc.twig' %}
		{% endif %}
	</div>
{% endblock %}
